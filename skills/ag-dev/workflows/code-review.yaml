id: code-review
name: Code Review — Multi-Agent Quality Assurance
description: Comprehensive code review with architect + QA + security perspectives. Use for PRs, pre-deploy audits, or quality gates.

phases:
  - id: architect-review
    phase: 1
    agent: architect
    parallel: true
    task: |
      Review code changes for:
      - Architecture alignment (patterns, conventions, separation of concerns)
      - Performance implications (N+1 queries, memory leaks, unnecessary re-renders)
      - Scalability concerns
      - API design quality
      - Dependency additions (justified? maintained? secure?)
      Save findings with severity: CRITICAL / WARNING / SUGGESTION
    output: .agdev/handoff/review-architecture.md

  - id: qa-review
    phase: 1
    agent: qa
    parallel: true
    task: |
      Review code changes for:
      - Test coverage (are new paths tested?)
      - Edge cases not handled
      - Error handling quality
      - Input validation
      - Regression risk assessment
      - Testability of new code
      Save findings with verdict: APPROVE / CONCERNS / REJECT
    output: .agdev/handoff/review-qa.md

  - id: security-review
    phase: 1
    agent: devops
    parallel: true
    task: |
      Review code changes for:
      - Security vulnerabilities (injection, XSS, CSRF, auth bypass)
      - Secrets or credentials in code
      - Dependency vulnerabilities
      - Permission and access control issues
      - Data exposure risks
      Save findings with severity: CRITICAL / WARNING / INFO
    output: .agdev/handoff/review-security.md

  - id: consolidation
    phase: 2
    agent: po
    task: |
      Consolidate all review findings into a single report.
      - Merge findings from architecture, QA, and security reviews
      - Deduplicate overlapping concerns
      - Prioritize by severity and effort to fix
      - Final verdict: APPROVE / APPROVE_WITH_NOTES / REQUEST_CHANGES / BLOCK
      
      Rules:
      - Any CRITICAL finding → BLOCK
      - Any QA REJECT → REQUEST_CHANGES
      - Only SUGGESTIONS remaining → APPROVE_WITH_NOTES
      - Clean reviews → APPROVE
    input:
      - .agdev/handoff/review-architecture.md
      - .agdev/handoff/review-qa.md
      - .agdev/handoff/review-security.md
    output: .agdev/handoff/review-consolidated.md

  - id: fix-cycle
    condition: verdict is REQUEST_CHANGES
    repeat: max 3 iterations
    steps:
      - agent: dev
        task: |
          Fix issues listed in the consolidated review.
          Address CRITICAL and WARNING items first.
          For each fix, reference the original finding ID.
        input: .agdev/handoff/review-consolidated.md
        output: code changes + .agdev/handoff/dev-fixes.md

      - agent: qa
        task: |
          Re-review fixed code.
          Verify each finding was addressed.
          Verdict: APPROVE / REJECT with remaining issues.
        input: .agdev/handoff/dev-fixes.md
        output: .agdev/handoff/review-qa.md
